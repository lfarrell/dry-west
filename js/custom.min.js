queue().defer(d3.json,"data/states/ca_counties.json").defer(d3.csv,"data/stations/ca_precip_stations_clean.csv").defer(d3.csv,"data/ca/ca_precip_clean.csv").await(function(d,f,l,e){function p(a){a.enter().append("circle").attr("class","map-circle");a.attr("cx",function(a){return h([a.lng,a.lat])[0]}).attr("cy",function(a){return h([a.lng,a.lat])[1]}).attr("r",2);a.exit().remove()}function q(a,c,v){w(c).forEach(function(a){a.point.cell=a});a.enter().append("path");a.attr("class","cell").attr("id",function(a){return"circle_"+a.station}).attr("d",function(a){return a.cell.length?"M"+a.cell.join("L")+"Z":null}).style("fill",function(a){for(var c,b=0;b<m;b++)if(a.station===e[b].station&&e[b].num_date===parseInt(v)){c=e[b];break}return r[c.station+"-"+c.month](c.dpnp)});a.exit().remove()}function t(a){for(var c=[],b=0;b<l.length;b++)for(var d=0;d<m;d++)if(l[b].station===e[d].station&&e[d].num_date===parseInt(a)){c.push(l[b]);break}return c}var x=d3.time.format("%m-%Y").parse,y="#543005 #8c510a #bf812d #dfc27d #f6e8c3 #f5f5f5 #c7eae5 #80cdc1 #35978f #01665e #003c30".split(" ");e.forEach(function(a){a.num_date=+a.date;a.month=a.date.substr(4,2);a.date=x(a.month+"-"+a.date.substr(0,4))});var m=e.length;d=window.innerWidth-100-50-50;var g=1,h=d3.geo.mercator().scale(g).translate([0,0]),k=d3.geo.path().projection(h),b=k.bounds(f),g=.98/Math.max((b[1][0]-b[0][0])/d,(b[1][1]-b[0][1])/505),b=[(d-g*(b[1][0]+b[0][0]))/2,(505-g*(b[1][1]+b[0][1]))/2],h=d3.geo.mercator().scale(g).translate(b),k=k.projection(h),r={};l.forEach(function(a){var c=[];c[0]=+a.lng;c[1]=+a.lat;c=h(c);a.x=c[0];a.y=c[1];for(var c=[],b=0;b<m&&-1===c.indexOf(e[b].station);b++)if(a.station===e[b].station){c.push(e[b].station);c=e.filter(function(b){return a.station===b.station});d3.nest().key(function(a){return a.month}).entries(c).forEach(function(a){r[e[b].station+"-"+a.key]=d3.scale.quantize().domain(d3.extent(a.values,\u0192("dpnp"))).range(y)});break}});g=t(200001);b=d3.select("#map").append("svg").attr("height",505).attr("width",d);b.append("defs").append("clipPath").attr("id","clipped-map").selectAll("path").data(f.features).enter().append("path").attr("d",
        k);var n=b.append("g");f=n.selectAll("path").data(f.features);f.enter().append("path");f.attr("d",k);f=n.selectAll("circle").data(g);p(f);var w=d3.geom.voronoi().x(function(a){return a.x}).y(function(a){return a.y}).clipExtent([[0,0],[d,505]]),u=b.append("g").attr("id","voronoi").attr("clip-path","url(#clipped-map)");f=u.selectAll(".cell").data(g);q(f,g,200001);d=chroniton().domain(d3.extent(e,function(a){return a.date})).width(d).labelFormat(d3.time.format("%B, %Y")).on("change",function(a){var b=
        a.getFullYear();a=a.getMonth()+1;10>a&&(a="0"+a);b=b+""+a;a=t(b);var d=n.selectAll("circle").data(a);p(d);q(u.selectAll(".cell").data(a),a,b)});d3.select("#slider").call(d);d=d3.selectAll(".row");d.classed("opaque",!1);d.classed("hide",!1);d3.selectAll("#load").classed("hide",!0)});